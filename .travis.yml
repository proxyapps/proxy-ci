language: cpp

sudo: required

services:
- docker

env:
  matrix:
  - APP=amg DOCKEROS=ubuntu
  - APP="candle-benchmarks ^libjpeg ^opengl@3.4.2" DEPS="python@2.7.15" DOCKEROS=ubuntu
  - APP=examinimd DOCKEROS=ubuntu
  - APP=laghos DOCKEROS=ubuntu VERBOSE="-v"
  - APP=macsio DOCKEROS=ubuntu
  - APP=miniamr DOCKEROS=ubuntu
  - APP=minife DOCKEROS=ubuntu
  - APP=minitri DOCKEROS=ubuntu
  - APP=nekbone DOCKEROS=ubuntu
  - APP=sw4lite DOCKEROS=ubuntu VERBOSE="-v"
  - APP=swfft DOCKEROS=ubuntu VERBOSE="-v"
  - APP=xsbench DOCKEROS=ubuntu
  - APP=amg2013 DOCKEROS=ubuntu
  - APP=aspa DOCKEROS=ubuntu VERBOSE="-v"
  - APP=branson DOCKEROS=ubuntu VERBOSE="-v"
  - APP=chatterbug DOCKEROS=ubuntu
  - APP=clamr DOCKEROS=ubuntu
  - APP=cloverleaf DOCKEROS=ubuntu
  - APP=cloverleaf3d DOCKEROS=ubuntu
  - APP=coevp DOCKEROS=ubuntu VERBOSE="-v"
  - APP=cohmm DOCKEROS=ubuntu
  - APP=comd DOCKEROS=ubuntu
  - APP=cosp2 DOCKEROS=ubuntu
  - APP=ebms DOCKEROS=ubuntu
  - APP=ember DOCKEROS=ubuntu
  - APP=exampm DOCKEROS=ubuntu
  - APP=exasp2 DOCKEROS=ubuntu VERBOSE="-v"
  - APP=hacckernels DOCKEROS=ubuntu
  - APP=hpccg DOCKEROS=ubuntu
  - APP=hpgmg DOCKEROS=ubuntu
  - APP=kripke DOCKEROS=ubuntu
  - APP=lcals DOCKEROS=ubuntu
  - APP=lulesh DOCKEROS=ubuntu
  - APP=miniaero DOCKEROS=ubuntu
  - APP=miniamr DOCKEROS=ubuntu
  - APP=minighost DOCKEROS=ubuntu
  - APP=minimd DOCKEROS=ubuntu
  - APP=miniqmc DOCKEROS=ubuntu VERBOSE="-v"
  - APP=minismac2d DOCKEROS=ubuntu
  - APP=minivite DOCKEROS=ubuntu
  - APP=minixyce DOCKEROS=ubuntu
  - APP=nut DOCKEROS=ubuntu
  - APP=pathfinder DOCKEROS=ubuntu
  - APP=pennant DOCKEROS=ubuntu
  - APP=picsarlite DOCKEROS=ubuntu
  - APP=rsbench DOCKEROS=ubuntu
  - APP=simplemoc DOCKEROS=ubuntu
  - APP=snap DOCKEROS=ubuntu
  - APP=snbone DOCKEROS=ubuntu
  - APP=tealeaf DOCKEROS=ubuntu
  - APP=thornado-mini DOCKEROS=ubuntu
  - APP=amg DOCKEROS=fedora
  - APP="candle-benchmarks ^libjpeg ^opengl@3.4.2" DEPS="python" DOCKEROS=fedora
  - APP=examinimd DOCKEROS=fedora
  - APP=laghos DOCKEROS=fedora VERBOSE="-v"
  - APP=macsio DOCKEROS=fedora
  - APP=miniamr DOCKEROS=fedora
  - APP=minife DOCKEROS=fedora
  - APP=minitri DOCKEROS=fedora
  - APP=nekbone DOCKEROS=fedora
  - APP=sw4lite DOCKEROS=fedora VERBOSE="-v"
  - APP=swfft DOCKEROS=fedora VERBOSE="-v"
  - APP=xsbench DOCKEROS=fedora
  - APP=amg2013 DOCKEROS=fedora
  - APP=aspa DOCKEROS=fedora VERBOSE="-v"
  - APP=branson DOCKEROS=fedora VERBOSE="-v"
  - APP=chatterbug DOCKEROS=fedora
  - APP=clamr DOCKEROS=fedora
  - APP=cloverleaf DOCKEROS=fedora
  - APP=cloverleaf3d DOCKEROS=fedora
  - APP=coevp DOCKEROS=fedora VERBOSE="-v"
  - APP=cohmm DOCKEROS=fedora
  - APP=comd DOCKEROS=fedora
  - APP=cosp2 DOCKEROS=fedora
  - APP=ebms DOCKEROS=fedora
  - APP=ember DOCKEROS=fedora
  - APP=exampm DOCKEROS=fedora
  - APP=exasp2 DOCKEROS=fedora VERBOSE="-v"
  - APP=hacckernels DOCKEROS=fedora
  - APP=hpccg DOCKEROS=fedora
  - APP=hpgmg DOCKEROS=fedora
  - APP=kripke DOCKEROS=fedora
  - APP=lcals DOCKEROS=fedora
  - APP=lulesh DOCKEROS=fedora
  - APP=miniaero DOCKEROS=fedora
  - APP=miniamr DOCKEROS=fedora
  - APP=minighost DOCKEROS=fedora
  - APP=minimd DOCKEROS=fedora
  - APP=miniqmc DOCKEROS=fedora VERBOSE="-v"
  - APP=minismac2d DOCKEROS=fedora
  - APP=minivite DOCKEROS=fedora
  - APP=minixyce DOCKEROS=fedora
  - APP=nut DOCKEROS=fedora
  - APP=pathfinder DOCKEROS=fedora
  - APP=pennant DOCKEROS=fedora
  - APP=picsarlite DOCKEROS=fedora
  - APP=rsbench DOCKEROS=fedora
  - APP=simplemoc DOCKEROS=fedora
  - APP=snap DOCKEROS=fedora
  - APP=snbone DOCKEROS=fedora
  - APP=tealeaf DOCKEROS=fedora
  - APP=thornado-mini DOCKEROS=fedora

before_install:
  - cp -vr docker ${HOME}/docker
  - cd ../../
  - mv -v ${TRAVIS_REPO_SLUG} $HOME/docker
  - cp -r $HOME/.ccache ${HOME}/docker/ccache
  - git clone --depth 1 https://github.com/spack/spack ${HOME}/docker/spack
  - source ${HOME}/docker/spack/share/spack/setup-env.sh
  - if spack info ${APP} | grep -q mantevo.org/downloads; then INSECURE="--insecure"; fi
  - for i in $(spack list -t proxy-app | grep -v ecp-proxy-apps); do
      echo "Looking for $i .travis.yml"; grep -q "APP=['\"]*$i" ${HOME}/docker/proxy-ci/.travis.yml || exit 1;
    done

script:
- travis_retry timeout 540 docker pull $(sed -n '1s/from //p' ${HOME}/docker/Dockerfile-${DOCKEROS})
- travis_retry docker build 
    --build-arg APP="${APP}" --build-arg DEPS="${DEPS}" --build-arg INSECURE="${INSECURE}" --build-arg VERBOSE="${VERBOSE}"
    -t ${TRAVIS_REPO_SLUG}:${APP%% *}_${DOCKEROS} ${HOME}/docker/ --file="${HOME}/docker/Dockerfile-${DOCKEROS}" &&
  rm -rf ${HOME}/.ccache &&
  CON=$(docker run -d ${TRAVIS_REPO_SLUG}:${APP%% *}_${DOCKEROS} /bin/bash) &&
  docker cp ${CON}:/home/ci/.ccache ${HOME}/

after_success:
- if [[ ${TRAVIS_BRANCH} = master ]]; then DEPLOY=yes; fi
- if [[ ${DEPLOY} = yes && ${DOCKER_USERNAME} && ${DOCKER_PASSWORD} && ${TRAVIS_PULL_REQUEST} == false ]]; then
    docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
    docker push "${TRAVIS_REPO_SLUG}:${APP%% *}_${DOCKEROS}";
  fi

cache:
  ccache: true

compiler:
- gcc

notifications:
  email:
    recipients:
      secure: hVpVVqjF5s0TThDx0E5a7fDTEHUlTfv5l0+NHjk1Xj+bA5aV+CgupHXZQaJMq6KEaxnxrnMUm/GqY6BHsAAUOdirPF/l30bez5oHiStBz05EK3HuP/bX997Xc/H6oZnfkAv1HOWIVba9nLTlJIxjkhovzNi7lMh3GGMps+7ApeQ0abWjoerWsfpqlPTljQK2548mfhKs8jP9sT29vbCW9LArzzUtcp1VgScMZC0r/CslLWK9nxEkqvkl6uqU377DXlUO9+XlOktyO+Ut/LcVncwhL2rlshtLi4ExUDFxQiLJd10irZW4ha45WOwgHh1EmyUibTgl84wOiiWSohUZLOp9rQynqdx8lfMMChn9DKXamhSdQz/SBm7kdfyFLBkQxCDP4eaYV/cS5aVfvWji/H6O6tYZvjbL1O3nPY9e/2nNfzAZCiEGCmBHROTe95l/hq8aU7PX1ykuOlN2X/A84tj3W2tAbPSu5fa5ZsBAw/m1JjCwXkkQT3wEqCA7Q7O4LJy8hiZKVLOAQm+ZA18W+oYDSm/NbdRf+QJwtFR3/MQJeE4BvvuhMNvYfb6ErTcXmXbabBe7VA3fYOROzWSHa1lAr30TjvdQUMOuG7ao50acjTovtaHBMkwMAPYX5yMMODJG+oB6PwSo9QIoCHl4FVhMzQGrqJF7XRvJ5Yz8o9k=
